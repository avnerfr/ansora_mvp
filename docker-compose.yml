version: '3.8'

services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: marketing-mvp-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    networks:
      - marketing-mvp-network

  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    container_name: marketing-mvp-backend
    ports:
      - "8000:8000"
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      # Use QDRANT_URL from host/.env instead of hardcoded Docker URL
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
      - STORAGE_PATH=/app/storage
      - ALLOWED_ORIGINS=http://localhost:3000
    volumes:
      - ./backend:/app  # Mount code directory
      - backend_storage:/app/storage
      - backend_db:/app/db
    depends_on:
      - qdrant
    networks:
      - marketing-mvp-network
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload --log-config logging_config.json
    extra_hosts:
      - "host.docker.internal:host-gateway"
volumes:
  qdrant_storage:
  backend_storage:
  backend_db:

networks:
  marketing-mvp-network:
    driver: bridge

